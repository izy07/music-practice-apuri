name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

# GitHub Pagesã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æœ‰åŠ¹åŒ–

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        run: |
          echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¾ã™..."
          echo "EXPO_PUBLIC_WEB_BASE: ${{ env.EXPO_PUBLIC_WEB_BASE || 'æœªè¨­å®š' }}"
          echo "GITHUB_PAGES_BASE: ${{ env.GITHUB_PAGES_BASE || 'æœªè¨­å®š' }}"
          echo "NODE_ENV: ${{ env.NODE_ENV || 'æœªè¨­å®š' }}"

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: |
          echo "ğŸ“Œ Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
          node --version
          echo "ğŸ“Œ npmãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
          npm --version

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
          npm ci --legacy-peer-deps || {
            echo "âŒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "package-lock.jsonã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™..."
            ls -la package-lock.json || echo "package-lock.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç¢ºèª
        run: |
          echo "ğŸ” ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèªã—ã¾ã™..."
          if [ -f package.json ]; then
            echo "âœ… package.jsonãŒå­˜åœ¨ã—ã¾ã™"
            cat package.json | grep -A 2 '"build:web:github"' || echo "âš ï¸  build:web:githubã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          else
            echo "âŒ package.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ğŸ” å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã™..."
          [ -f scripts/create-robust-404.js ] && echo "âœ… scripts/create-robust-404.js ãŒå­˜åœ¨ã—ã¾ã™" || echo "âŒ scripts/create-robust-404.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          [ -f scripts/fix-github-pages-paths.js ] && echo "âœ… scripts/fix-github-pages-paths.js ãŒå­˜åœ¨ã—ã¾ã™" || echo "âŒ scripts/fix-github-pages-paths.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      - name: Webãƒ“ãƒ«ãƒ‰ï¼ˆGitHub Pagesç”¨ï¼‰
        run: |
          echo "ğŸ”§ ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™..."
          echo "ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª:"
          echo "  EXPO_PUBLIC_WEB_BASE: $EXPO_PUBLIC_WEB_BASE"
          echo "  GITHUB_PAGES_BASE: $GITHUB_PAGES_BASE"
          echo "  NODE_ENV: $NODE_ENV"
          
          npm run build:web:github || {
            echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
            pwd
            echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la dist/ 2>&1 || echo "distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ğŸ“ scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la scripts/ 2>&1 || echo "scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ğŸ“‹ npm run build:web:github ã®è©³ç´°ã‚¨ãƒ©ãƒ¼:"
            exit 1
          }
          
          echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ“ ãƒ“ãƒ«ãƒ‰å¾Œã®distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la dist/ || echo "âš ï¸  distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        env:
          EXPO_PUBLIC_WEB_BASE: /music-practice-apuri
          GITHUB_PAGES_BASE: /music-practice-apuri
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL || 'https://uteeqkpsezbabdmritkn.supabase.co' }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZWVxa3BzZXpiYWJkbXJpdGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDQyNDUsImV4cCI6MjA3MDcyMDI0NX0.3wITO5E53yW2spDHi99ngaA0SRqnsJbAYzdT7DDa1tM' }}
          NODE_ENV: production

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è©³ç´°ç¢ºèª:"
          if [ ! -d dist ]; then
            echo "âŒ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ğŸ“ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la dist/
          echo ""
          echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚µã‚¤ã‚º:"
          du -sh dist/ || echo "ã‚µã‚¤ã‚ºå–å¾—ã«å¤±æ•—"
          echo ""
          echo "ğŸ“„ ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          [ -f dist/index.html ] && echo "âœ… index.html ãŒå­˜åœ¨ã—ã¾ã™ ($(wc -c < dist/index.html) bytes)" || {
            echo "âŒ index.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          [ -f dist/404.html ] && echo "âœ… 404.html ãŒå­˜åœ¨ã—ã¾ã™ ($(wc -c < dist/404.html) bytes)" || echo "âš ï¸  404.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå¾Œã§ä½œæˆã•ã‚Œã¾ã™ï¼‰"
          [ -f dist/.nojekyll ] && echo "âœ… .nojekyll ãŒå­˜åœ¨ã—ã¾ã™" || echo "âš ï¸  .nojekyll ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå¾Œã§ä½œæˆã•ã‚Œã¾ã™ï¼‰"
          [ -f dist/metadata.json ] && echo "âœ… metadata.json ãŒå­˜åœ¨ã—ã¾ã™" || echo "âš ï¸  metadata.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          echo ""
          echo "ğŸ“ _expoãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª:"
          [ -d dist/_expo ] && echo "âœ… dist/_expo ãŒå­˜åœ¨ã—ã¾ã™" || echo "âš ï¸  dist/_expo ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          [ -d dist/assets ] && echo "âœ… dist/assets ãŒå­˜åœ¨ã—ã¾ã™" || echo "âš ï¸  dist/assets ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      - name: 404.htmlã®ä½œæˆï¼ˆSPAãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ï¼‰
        run: |
          echo "ğŸ”§ 404.htmlã‚’ä½œæˆã—ã¾ã™..."
          
          if [ ! -f dist/index.html ]; then
            echo "âŒ index.htmlãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€404.htmlã‚’ä½œæˆã§ãã¾ã›ã‚“"
            echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la dist/ 2>&1 || echo "distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -f scripts/create-robust-404.js ]; then
            echo "âŒ scripts/create-robust-404.jsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ“ scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la scripts/ 2>&1 || echo "scriptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª:"
          echo "  GITHUB_PAGES_BASE: $GITHUB_PAGES_BASE"
          echo "  EXPO_PUBLIC_WEB_BASE: $EXPO_PUBLIC_WEB_BASE"
          
          node scripts/create-robust-404.js || {
            echo "âŒ 404.htmlã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }
          
          if [ -f dist/404.html ]; then
            echo "âœ… 404.htmlã‚’ä½œæˆã—ã¾ã—ãŸ ($(wc -c < dist/404.html) bytes)"
          else
            echo "âŒ 404.htmlã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼‰"
            exit 1
          fi
        env:
          GITHUB_PAGES_BASE: /music-practice-apuri
          EXPO_PUBLIC_WEB_BASE: /music-practice-apuri

      - name: .nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        run: |
          echo "ğŸ”§ .nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™..."
          if [ ! -d dist ]; then
            echo "âŒ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "" > dist/.nojekyll
          if [ -f dist/.nojekyll ]; then
            echo "âœ… .nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "âŒ .nojekyllãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: æœ€çµ‚ç¢ºèª
        run: |
          echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ç¢ºèª:"
          echo "ğŸ“ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la dist/
          echo ""
          echo "ğŸ“„ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª:"
          [ -f dist/index.html ] && echo "âœ… index.html" || {
            echo "âŒ index.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          [ -f dist/404.html ] && echo "âœ… 404.html" || {
            echo "âŒ 404.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          [ -f dist/.nojekyll ] && echo "âœ… .nojekyll" || {
            echo "âŒ .nojekyll ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          echo ""
          echo "ğŸ“Š ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚µã‚¤ã‚º:"
          du -sh dist/ || echo "ã‚µã‚¤ã‚ºå–å¾—ã«å¤±æ•—"
          echo ""
          echo "âœ… ã™ã¹ã¦ã®å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæƒã£ã¦ã„ã¾ã™"

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
        continue-on-error: false

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ç¢ºèª
        run: |
          echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ç¢ºèª:"
          echo "GitHub Pagesç’°å¢ƒ: github-pages"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å…ƒã‚¸ãƒ§ãƒ–: build"
          
      - name: GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: false
        
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®ç¢ºèª
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ“Œ ãƒ‡ãƒ—ãƒ­ã‚¤URL: ${{ steps.deployment.outputs.page_url }}"
          if [ -z "${{ steps.deployment.outputs.page_url }}" ]; then
            echo "âš ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "GitHub Pagesã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi


name: Database Migration Check

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
  pull_request:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:

jobs:
  migration-check:
    name: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci --legacy-peer-deps

      - name: Supabase CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
          supabase --version || {
            echo "âŒ Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          echo "âœ… Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Supabase ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®èµ·å‹•
        run: supabase start
        env:
          SUPABASE_DB_PASSWORD: postgres
          SUPABASE_DB_PORT: 5432

      - name: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
        run: |
          echo "ğŸ“‹ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."
          supabase db diff --schema public || echo "âš ï¸  ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"

      - name: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
        run: |
          echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          supabase db reset
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ç¢ºèª
        run: |
          echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ:"
          supabase db execute "
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            ORDER BY table_name;
          " || true

      - name: instrumentsãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
        run: |
          echo "ğŸ¹ instrumentsãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª:"
          supabase db execute "
            SELECT 
              COUNT(*) as total,
              COUNT(CASE WHEN id = '550e8400-e29b-41d4-a716-446655440016' THEN 1 END) as other_exists
            FROM instruments;
          " || echo "âš ï¸  instrumentsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"

      - name: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®ç¢ºèª
        run: |
          echo "ğŸ”— å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®ç¢ºèª:"
          supabase db execute "
            SELECT 
              conname as constraint_name,
              conrelid::regclass as table_name
            FROM pg_constraint
            WHERE contype = 'f'
            AND conname LIKE '%instrument%';
          " || true

      - name: Supabase ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®åœæ­¢
        if: always()
        run: supabase stop


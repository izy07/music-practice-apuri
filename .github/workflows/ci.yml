name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã—ï¼‰
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå˜ä½“ãƒ†ã‚¹ãƒˆï¼‰
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci --legacy-peer-deps

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
          npm run test:ci || {
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }
          echo "âœ… ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
        env:
          NODE_ENV: test
          CI: 'true'
          GITHUB_ACTIONS: 'true'
        timeout-minutes: 10

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
  test-database:
    name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    # PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯å‰Šé™¤ï¼ˆSupabaseãŒç‹¬è‡ªã®PostgreSQLã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ãŸã‚ä¸è¦ï¼‰
    # ãƒãƒ¼ãƒˆç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€Supabaseã®config.tomlã§è¨­å®šã•ã‚ŒãŸãƒãƒ¼ãƒˆï¼ˆ54322ï¼‰ã‚’ä½¿ç”¨

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Docker ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci --legacy-peer-deps

      - name: Supabase CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
          # Homebrewã‚’ä½¿ç”¨ã—ã¦Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
          supabase --version || {
            echo "âŒ Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          echo "âœ… Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Supabase ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®èµ·å‹•
        run: |
          echo "ğŸš€ Supabaseãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã™..."
          # æ—¢å­˜ã®Supabaseã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          supabase stop || echo "âš ï¸ æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆæ–°è¦èµ·å‹•ã‚’ç¶šè¡Œï¼‰"
          # Supabaseã‚’èµ·å‹•ï¼ˆconfig.tomlã®è¨­å®šã‚’ä½¿ç”¨ï¼šDBãƒãƒ¼ãƒˆ54322ï¼‰
          supabase start || {
            echo "âŒ Supabaseã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            docker ps -a | grep supabase || echo "Supabaseã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          }
          echo "â³ Supabaseã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
          sleep 10
          echo "ğŸ“Š Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
          supabase status || {
            echo "âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™"
          }
          echo "âœ… Supabaseã®èµ·å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ"
        env:
          SUPABASE_DB_PASSWORD: postgres
          # config.tomlã§54322ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãã—ãªã„
          # SUPABASE_DB_PORTã¯è¨­å®šã—ãªã„ï¼ˆconfig.tomlã®è¨­å®šã‚’ä½¿ç”¨ï¼‰
        timeout-minutes: 5

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
        run: |
          echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™..."
          supabase db reset || {
            echo "âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            supabase db diff --schema public || echo "db diffã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"
        timeout-minutes: 5

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã®ç¢ºèª
        run: |
          echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§:"
          supabase db diff --schema public || true
        continue-on-error: true

      - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
          npm run test:ci -- __tests__/integration/ || {
            echo "âŒ çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“Š Supabaseã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
            supabase status || echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—"
            exit 1
          }
          echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
        env:
          EXPO_PUBLIC_SUPABASE_URL: http://127.0.0.1:54321
          EXPO_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
          NODE_ENV: test
          CI: 'true'
          GITHUB_ACTIONS: 'true'
        timeout-minutes: 10

      - name: Supabase ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®åœæ­¢
        if: always()
        run: supabase stop || true

  # Lint ãƒã‚§ãƒƒã‚¯
  lint:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci --legacy-peer-deps

      - name: å‹ãƒã‚§ãƒƒã‚¯
        run: npx tsc --noEmit
        continue-on-error: false

  # ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  build:
    name: ãƒ“ãƒ«ãƒ‰ç¢ºèª
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'failure') && (needs.lint.result == 'success' || needs.lint.result == 'failure')
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci --legacy-peer-deps

      - name: Web ãƒ“ãƒ«ãƒ‰
        run: npm run build:web
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL || 'https://uteeqkpsezbabdmritkn.supabase.co' }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZWVxa3BzZXpiYWJkbXJpdGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDQyNDUsImV4cCI6MjA3MDcyMDI0NX0.3wITO5E53yW2spDHi99ngaA0SRqnsJbAYzdT7DDa1tM' }}
          NODE_ENV: production

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 7

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
          npm ci --legacy-peer-deps || {
            echo "âŒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“Š package-lock.jsonã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }
          echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        run: npm audit --production
        continue-on-error: true

      - name: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ¼æ´©ãƒã‚§ãƒƒã‚¯
        run: |
          if grep -r "test@example.com" supabase/migrations/; then
            echo "âš ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
            exit 1
          fi
          echo "âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¼æ´©ãªã—"

      - name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
        run: |
          if grep -r "testpassword123" app/ components/ lib/; then
            echo "âš ï¸ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi
          echo "âœ… ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ãªã—"


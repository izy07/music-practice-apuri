# 機能フロー分析計画（更新版）

## 分析状況

### ✅ 完了した分析

1. ✅ **認証フロー** - `docs/FLOW_ANALYSIS_01_AUTH.md`
2. ✅ **練習記録フロー** - `docs/FLOW_ANALYSIS_02_PRACTICE_RECORD.md`
3. ✅ **タイマーフロー** - `docs/FLOW_ANALYSIS_03_TIMER.md`
4. ✅ **目標管理フロー** - `docs/FLOW_ANALYSIS_04_GOAL.md`
5. ✅ **チューナーフロー** - `docs/FLOW_ANALYSIS_05_TUNER.md`
6. ✅ **組織管理フロー** - `docs/FLOW_ANALYSIS_06_ORGANIZATION.md`
7. ✅ **カレンダー表示フロー** - `docs/FLOW_ANALYSIS_07_CALENDAR.md`
8. ✅ **学習ツール（基礎練習）フロー** - `docs/FLOW_ANALYSIS_08_BASIC_PRACTICE.md`
9. ✅ **グラフ統計フロー** - `docs/FLOW_ANALYSIS_09_STATISTICS.md`
10. ✅ **代表曲フロー** - `docs/FLOW_ANALYSIS_10_REPRESENTATIVE_SONGS.md`
11. ✅ **プロフィール設定フロー** - `docs/FLOW_ANALYSIS_11_PROFILE_SETTINGS.md`
12. ✅ **マイライブラリフロー** - `docs/FLOW_ANALYSIS_12_MY_LIBRARY.md`
13. ✅ **録音ライブラリフロー** - `docs/FLOW_ANALYSIS_13_RECORDING_LIBRARY.md`
14. ✅ **楽器選択・変更フロー** - `docs/FLOW_ANALYSIS_14_INSTRUMENT_SELECTION.md`
15. ✅ **外観設定フロー** - `docs/FLOW_ANALYSIS_15_APPEARANCE_SETTINGS.md`

## 分析結果サマリー

### 主要な問題点（優先度: 高）

1. **パスワードの平文保存** (`FLOW_ANALYSIS_06_ORGANIZATION.md`)
   - 場所: `services/organizationService.ts:188-189`
   - 問題: 組織作成時にパスワードの平文も保存されている
   - 改善: `password`カラムに平文を保存しない（`password_hash`のみ）

2. **カレンダー画面のキャッシュ問題** (`FLOW_ANALYSIS_07_CALENDAR.md`)
   - 場所: `hooks/tabs/useCalendarData.ts`
   - 問題: 楽器変更時にキャッシュがクリアされていない
   - 改善: キャッシュキーに楽器IDを含める、または楽器変更時にクリア

3. **固定待機時間の使用** (複数機能)
   - タイマー完了通知: 1000ms (`FLOW_ANALYSIS_03_TIMER.md`)
   - 楽器変更: 100ms + 800ms (`FLOW_ANALYSIS_14_INSTRUMENT_SELECTION.md`)
   - 組織作成: 500ms (`FLOW_ANALYSIS_06_ORGANIZATION.md`)
   - 改善: Promiseベースで処理の完了を待つ

4. **Audio APIのメモリリーク** (`FLOW_ANALYSIS_05_TUNER.md`, `FLOW_ANALYSIS_13_RECORDING_LIBRARY.md`)
   - 問題: AudioContextやAudioオブジェクトのクリーンアップ不足
   - 改善: `useEffect`のクリーンアップ関数でクリーンアップ

5. **全期間データ取得のパフォーマンス問題** (`FLOW_ANALYSIS_09_STATISTICS.md`)
   - 問題: 統計画面で全期間（1970-01-01から）のデータを一度に取得
   - 改善: 必要な期間のみ取得（例: 最近1年分）

6. **エントイトルメントの模擬値** (`FLOW_ANALYSIS_12_MY_LIBRARY.md`)
   - 問題: マイライブラリでエントイトルメントが模擬値（常にtrue）
   - 改善: `useSubscription`フックを使用

### 主要な問題点（優先度: 中）

7. **AsyncStorageとデータベースの二重管理** (複数機能)
   - 改善: データベースを唯一の情報源にする

8. **オプショナルカラムの保存問題** (`FLOW_ANALYSIS_11_PROFILE_SETTINGS.md`)
   - 改善: マイグレーション実行後にコメントを解除

9. **イベント受信方法の不統一** (`FLOW_ANALYSIS_14_INSTRUMENT_SELECTION.md`)
   - 改善: すべての画面で`window.addEventListener('instrumentChanged')`を使用

10. **リトライロジックの複雑さ** (複数機能)
    - 改善: 共通化または簡素化

## 解決済み問題

以下の問題は既に解決済みです：

1. ✅ **完了検出の簡素化** (`FLOW_ANALYSIS_03_TIMER.md`)
2. ✅ **完了状態リセットの統一** (`FLOW_ANALYSIS_03_TIMER.md`)
3. ✅ **タイマー完了検出の競合状態の解決** (`FLOW_ANALYSIS_03_TIMER.md`)
4. ✅ **timerPresetRefの同期問題の解決** (`FLOW_ANALYSIS_03_TIMER.md`)
5. ✅ **AsyncStorageキーの統一** (`FLOW_ANALYSIS_03_TIMER.md`)
6. ✅ **カレンダー更新イベントの改善** (`FLOW_ANALYSIS_03_TIMER.md`)
7. ✅ **練習時間計算の改善** (`FLOW_ANALYSIS_03_TIMER.md`)
8. ✅ **代表曲データの重複問題** (`FLOW_ANALYSIS_10_REPRESENTATIVE_SONGS.md`)

## 次のステップ

### 最優先（セキュリティ・データ整合性）

1. **パスワードの平文保存を削除** (`FLOW_ANALYSIS_06_ORGANIZATION.md`)
2. **カレンダー画面のキャッシュクリア** (`FLOW_ANALYSIS_07_CALENDAR.md`)

### 高優先度（パフォーマンス・信頼性）

3. **固定待機時間の削除** (複数機能)
4. **Audio APIのメモリリーク解消** (複数機能)
5. **全期間データ取得の最適化** (`FLOW_ANALYSIS_09_STATISTICS.md`)
6. **エントイトルメントの実際の値取得** (`FLOW_ANALYSIS_12_MY_LIBRARY.md`)

### 中優先度（コード品質・保守性）

7. **AsyncStorageとデータベースの統一** (複数機能)
8. **オプショナルカラムの保存有効化** (`FLOW_ANALYSIS_11_PROFILE_SETTINGS.md`)
9. **イベント受信方法の統一** (`FLOW_ANALYSIS_14_INSTRUMENT_SELECTION.md`)
10. **リトライロジックの簡素化** (複数機能)

詳細な分析結果は、各レポートファイルを参照してください。


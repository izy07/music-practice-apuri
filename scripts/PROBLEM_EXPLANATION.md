# 問題の原因と解決方法

## 何が起きたのか

### 問題の症状
- 新規登録時に「既に登録されています」というエラーが表示される
- しかし、実際にはログインできない
- `auth.users`にユーザーは存在するが、`user_profiles`にプロフィールが存在しない

### 根本原因

1. **トリガーが適用されていなかった**
   - マイグレーションファイル（`20251222000000_auto_create_user_profile_trigger.sql`）は存在していた
   - しかし、実際のデータベースにトリガーが適用されていなかった
   - そのため、新規登録時に`auth.users`にユーザーが作成されても、`user_profiles`にプロフィールが自動作成されなかった

2. **アプリケーション側の処理が不完全だった**
   - `signup.tsx`でプロフィール作成を試みていたが、エラーが発生した場合に処理が中断されていた可能性がある
   - タイムアウトやネットワークエラーにより、プロフィール作成が失敗していた可能性がある

3. **データの不整合**
   - `auth.users`にユーザーが存在するが、`user_profiles`にプロフィールが存在しない状態が発生
   - この状態では、ログイン時に「新規登録されていません」というエラーが表示される

## 解決方法

### 1. トリガーの作成（完了）
- `on_auth_user_created`トリガーを作成
- `auth.users`にユーザーが作成されると、自動的に`user_profiles`にプロフィールが作成される

### 2. 既存ユーザーの修復（完了）
- プロフィールが存在しない既存ユーザーのプロフィールを作成

### 3. 今後の対策
- トリガーにより、新規登録時に自動的にプロフィールが作成される
- データの不整合が発生しないようになった

## なぜこの問題が起きたのか

### 技術的な原因
1. **マイグレーションの適用漏れ**
   - マイグレーションファイルは存在していたが、実際のデータベースに適用されていなかった
   - ローカル開発環境でマイグレーションが正しく実行されていなかった可能性がある

2. **タイミングの問題**
   - 新規登録処理中にエラーが発生し、プロフィール作成が中断された
   - ネットワークエラーやタイムアウトにより、プロフィール作成が失敗した

3. **エラーハンドリングの不備**
   - プロフィール作成が失敗した場合の処理が不十分だった
   - エラーが発生しても、ユーザーに適切なメッセージが表示されなかった

### 設計上の問題
1. **依存関係の管理**
   - `auth.users`と`user_profiles`の依存関係が明確でなかった
   - アプリケーション側でプロフィール作成を管理していたが、データベース側で自動化されていなかった

2. **トランザクション管理**
   - ユーザー作成とプロフィール作成が別々のトランザクションで実行されていた
   - そのため、一方が成功し、もう一方が失敗する可能性があった

## 今後の対策

### 1. トリガーの活用
- データベース側で自動的にプロフィールを作成するトリガーを適用
- アプリケーション側の処理に依存しない設計

### 2. マイグレーションの確認
- マイグレーションファイルが正しく適用されているか確認
- 定期的にデータベースの状態を確認する

### 3. エラーハンドリングの改善
- プロフィール作成が失敗した場合の処理を改善
- ユーザーに適切なエラーメッセージを表示

### 4. データ整合性の確保
- 定期的にデータの整合性をチェック
- 不整合が発生した場合の修復スクリプトを用意

## まとめ

この問題は、データベース側のトリガーが適用されていなかったことが根本原因でした。トリガーを適用することで、今後は新規登録時に自動的にプロフィールが作成され、同様の問題が発生しなくなります。


# 機能フロー分析レポート #9: グラフ統計フロー

## 概要
統計画面での練習記録の取得、期間別（日別・週別・月別・年別）のデータ集計、グラフ表示、楽器変更時のデータ切り替えの各フローを詳細に分析し、余分な工程や潜在的なバグを特定する。

## 1. 統計データ取得フロー

### ユーザー操作の流れ
1. 統計画面 (`app/(tabs)/statistics.tsx`) を開く
2. 全期間の練習記録が自動的に読み込まれる
3. 楽器変更時にデータが再取得される

### データの流れ

#### フロントエンド処理 (`app/(tabs)/statistics.tsx`)
```
画面表示 / 楽器変更
  ↓
fetchPracticeRecords()
  ├─ practiceService.getSessionsByDateRange()
  │  └─ 全期間（1970-01-01から）を取得
  │     ├─ 楽器IDでフィルタリング
  │     └─ 最大件数制限（DATA.MAX_PRACTICE_RECORDS）
  └─ practiceRecords状態を更新
```

### 問題点・余分な工程

#### 🟡 問題1: 全期間データの取得
**場所**: `app/(tabs)/statistics.tsx:112-118`
```typescript
const result = await practiceService.getSessionsByDateRange(
  user.id,
  '1970-01-01', // 全期間
  undefined,
  currentInstrumentId,
  DATA.MAX_PRACTICE_RECORDS
);
```

**問題**: 
- 全期間のデータを一度に取得している
- データ量が多い場合、パフォーマンスの問題がある可能性
- `MAX_PRACTICE_RECORDS`で制限しているが、全期間取得は不要な可能性

**改善提案**: 
- 必要な期間のみ取得（例: 最近1年分）
- または、ページネーションで取得

#### 🟡 問題2: 楽器変更時のデータ再取得
**場所**: `app/(tabs)/statistics.tsx:133-135`
- `selectedInstrument`が変更されると、全期間データを再取得
- 既に全期間データを取得しているため、フィルタリングで対応可能な可能性

**改善提案**: 
- 全期間データを一度取得し、クライアント側でフィルタリング
- または、楽器変更時に必要な期間のみ再取得

## 2. 期間別データ集計フロー

### データの流れ

#### 日別データ（当週） (`app/(tabs)/statistics.tsx:154-179`)
```
weeklyData
  ├─ 週の開始日を計算（月曜日基準）
  ├─ 練習記録を日付でマップ化
  └─ 7日分のデータを生成
```

#### 月別データ（6日ごとに5区分） (`app/(tabs)/statistics.tsx:182-211`)
```
monthlyData
  ├─ 月を5つの期間に分割
  ├─ 各期間の練習記録を集計
  └─ 5つのデータポイントを生成
```

#### 年別データ（12ヶ月） (`app/(tabs)/statistics.tsx:214-252`)
```
yearlyData
  ├─ 練習記録を月でマップ化
  ├─ 現在の月から過去12ヶ月分を生成
  └─ 12ヶ月分のデータポイントを生成
```

### 問題点

特に大きな問題は見当たらない（メモ化で最適化済み）。

## 3. グラフ表示フロー

### データの流れ (`app/(tabs)/statistics.tsx:31-89`)
```
BarChartコンポーネント
  ├─ データを受け取り
  ├─ 最大値からスケールを計算
  ├─ 棒グラフを描画
  └─ ラベルを表示
```

### 問題点

特に大きな問題は見当たらない。

## 4. 練習記録更新通知フロー

### データの流れ (`app/(tabs)/statistics.tsx:137-151`)
```
[練習記録保存]
  ↓
window.dispatchEvent('practiceRecordUpdated')
  ↓
handlePracticeRecordUpdate()
  └─ fetchPracticeRecords() - 全期間データを再取得
```

### 問題点

#### 🟡 問題1: 更新時の全期間データ再取得
**場所**: `app/(tabs)/statistics.tsx:139-141`
- 練習記録が更新されると、全期間データを再取得
- 追加された1件の記録のために全期間データを再取得するのは非効率

**改善提案**: 
- 更新された記録のみ追加
- または、必要な期間のみ再取得

## 5. 楽器変更時のデータ切り替えフロー

### データの流れ

#### イベント発火 (`app/(tabs)/instrument-selection.tsx:418-426`)
```
[楽器選択保存]
  ↓
window.dispatchEvent('instrumentChanged')
```

#### データ再取得 (`app/(tabs)/statistics.tsx:133-135`)
```
[楽器変更検知]
  ↓
selectedInstrument変更
  ↓
fetchPracticeRecords() - 新しい楽器IDで再取得
```

### 問題点

#### 🟡 問題1: 楽器変更時の全期間データ再取得
**場所**: `app/(tabs)/statistics.tsx:133-135`
- 楽器変更時に全期間データを再取得している
- 既に全期間データを取得している場合、フィルタリングで対応可能

**改善提案**: 
- 全期間データを一度取得し、クライアント側で楽器IDでフィルタリング
- または、楽器変更時に必要な期間のみ再取得

## 6. 統計計算フロー

### データの流れ (`app/(tabs)/statistics.tsx:286-405`)
```
getInputMethodStats - 練習方法別統計
getRecentRecords - 最近の練習記録
getAdditionalStats - 詳細統計
  ├─ 平均練習時間
  ├─ 最長連続練習日
  ├─ 週間練習パターン
  ├─ 月別練習傾向
  └─ 練習強度別統計
```

### 問題点

特に大きな問題は見当たらない（メモ化で最適化済み）。

## 7. 余分なファイル・重複コード

### 重複している処理

特に大きな重複は見当たらない。

## 8. 潜在的なバグ

### バグ1: 全期間データ取得のパフォーマンス問題
- データ量が多い場合、初回読み込みが遅くなる可能性
- メモリ使用量も増加

### バグ2: 更新時の全期間データ再取得
- 1件の記録追加のために全期間データを再取得
- ネットワーク負荷とパフォーマンスの問題

## 9. 改善提案まとめ

### 優先度: 高
1. **全期間データ取得の最適化**: 必要な期間のみ取得（例: 最近1年分）
2. **更新時の部分更新**: 更新された記録のみ追加、または必要な期間のみ再取得

### 優先度: 中
3. **楽器変更時のフィルタリング**: 全期間データを一度取得し、クライアント側でフィルタリング

### 優先度: 低
4. **ページネーション**: データ量が多い場合のページネーション対応

## 10. フロー図（テキストベース）

### 統計データ取得フロー
```
[画面表示 / 楽器変更]
  ↓
[fetchPracticeRecords()]
  ├─ practiceService.getSessionsByDateRange()
  │  └─ 全期間（1970-01-01から）を取得 ← ⚠️ パフォーマンス問題
  │     ├─ 楽器IDでフィルタリング
  │     └─ 最大件数制限
  └─ practiceRecords状態を更新
  ↓
[期間別データ集計]
  ├─ 日別（当週）
  ├─ 月別（6日ごとに5区分）
  └─ 年別（12ヶ月）
  ↓
[グラフ表示]
```

### 練習記録更新フロー
```
[練習記録保存]
  ↓
window.dispatchEvent('practiceRecordUpdated')
  ↓
[handlePracticeRecordUpdate()]
  └─ fetchPracticeRecords() - 全期間データを再取得 ← ⚠️ 非効率
```

## 11. 結論

グラフ統計フローは機能しているが、以下の改善が必要：
- 全期間データ取得の最適化（最重要）
- 更新時の部分更新
- 楽器変更時のフィルタリング最適化

これらの改善により、パフォーマンス向上とネットワーク負荷の削減が期待できる。




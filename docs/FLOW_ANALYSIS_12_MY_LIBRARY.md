# 機能フロー分析レポート #12: マイライブラリフロー

## 概要
楽曲の追加・編集・削除、ステータス別フィルタリング、ペイウォール対応の各フローを詳細に分析し、余分な工程や潜在的なバグを特定する。

## 1. 楽曲データ読み込みフロー

### ユーザー操作の流れ
1. マイライブラリ画面 (`app/(tabs)/my-library.tsx`) を開く
2. ユーザーの楽曲データが自動的に読み込まれる
3. ステータス別にフィルタリングされて表示される

### データの流れ

#### フロントエンド処理 (`app/(tabs)/my-library.tsx`)
```
画面表示
  ↓
loadSongs()
  ├─ ペイウォールチェック
  │  └─ canAccessFeature('my-library', entitlement)
  ├─ アクセス不可 → 空配列を設定
  ├─ アクセス可能 → データベースから取得
  │  └─ supabase.from('my_songs')
  │     .select('*')
  │     .eq('user_id', user.id)
  │     .order('created_at', { ascending: false })
  └─ songs状態を更新
  ↓
フィルタリング
  └─ filteredSongs = songs.filter(song => song.status === filterStatus)
```

### 問題点・余分な工程

#### 🟡 問題1: エントイトルメントの模擬値
**場所**: `app/(tabs)/my-library.tsx:34-36`
```typescript
// サブスクリプション状態を模擬（実際の実装では適切なフックを使用）
const entitlement = { isEntitled: true }; // 仮の値
const entitlementLoading = false;
```

**問題**: 
- エントイトルメントが模擬値（常にtrue）
- 実際のサブスクリプション状態を取得していない

**改善提案**: 
- `useSubscription`フックを使用して実際のサブスクリプション状態を取得
- または、コメントを追加して将来的に実装することを明記

#### 🟡 問題2: エラーハンドリングの不足
**場所**: `app/(tabs)/my-library.tsx:79-81`
```typescript
} catch (error) {
  // 曲の読み込みエラー
}
```

**問題**: 
- エラーハンドリングが空
- エラーが発生してもユーザーに通知されない

**改善提案**: 
- エラーハンドリングを追加
- エラーメッセージを表示

## 2. 楽曲保存フロー

### ユーザー操作の流れ
1. 「曲を追加」ボタンをクリック
2. モーダルで情報を入力
3. 「保存」ボタンをクリック
4. 楽曲がデータベースに保存される

### データの流れ (`app/(tabs)/my-library.tsx:84-172`)
```
[saveSong()]
  ├─ バリデーション
  │  └─ 曲名必須チェック
  ├─ 認証チェック
  ├─ 編集モード
  │  └─ supabase.from('my_songs').update()
  └─ 新規追加モード
     └─ supabase.from('my_songs').insert()
  └─ 成功メッセージ表示
```

### 問題点

特に大きな問題は見当たらない。

## 3. 楽曲削除フロー

### ユーザー操作の流れ
1. 楽曲カードの削除ボタンをクリック
2. 確認ダイアログが表示される
3. 「削除」を選択
4. 楽曲が削除される

### データの流れ (`app/(tabs)/my-library.tsx:174-201`)
```
[削除ボタンクリック]
  ↓
Alert.alert() - 確認ダイアログ
  ↓
[削除確認]
  ↓
supabase.from('my_songs').delete()
  └─ .eq('id', songId)
  ↓
loadSongs() - 一覧を再読み込み
```

### 問題点

特に大きな問題は見当たらない。

## 4. ステータス別フィルタリングフロー

### データの流れ (`app/(tabs)/my-library.tsx:238-239`)
```
[ステータス選択]
  ↓
setFilterStatus(status)
  ↓
filteredSongs = songs.filter(song => song.status === filterStatus)
```

### 問題点

特に大きな問題は見当たらない。

## 5. ペイウォール対応フロー

### データの流れ (`app/(tabs)/my-library.tsx:282-309`)
```
[ペイウォールチェック]
  ↓
canAccessFeature('my-library', entitlement)
  ├─ アクセス不可 → プレミアム限定表示
  └─ アクセス可能 → 通常の画面表示
```

### 問題点

#### 🟡 問題1: エントイトルメントの模擬値
**場所**: `app/(tabs)/my-library.tsx:34-36`
- エントイトルメントが模擬値（常にtrue）
- ペイウォールが正しく機能しない可能性

**改善提案**: 
- `useSubscription`フックを使用して実際のサブスクリプション状態を取得

## 6. 余分なファイル・重複コード

### 重複している処理

特に大きな重複は見当たらない。

## 7. 潜在的なバグ

### バグ1: エントイトルメントの模擬値
- エントイトルメントが模擬値（常にtrue）のため、ペイウォールが正しく機能しない
- 実際のサブスクリプション状態を取得する必要がある

### バグ2: エラーハンドリングの不足
- 楽曲の読み込みエラーが処理されていない
- エラーが発生してもユーザーに通知されない

## 8. 改善提案まとめ

### 優先度: 高
1. **エントイトルメントの実際の値取得**: `useSubscription`フックを使用
2. **エラーハンドリングの追加**: 楽曲の読み込みエラーを処理

### 優先度: 低
3. **コード整理**: 未使用のコードやコメントの整理

## 9. フロー図（テキストベース）

### 楽曲データ読み込みフロー
```
[画面表示]
  ↓
[loadSongs()]
  ├─ ペイウォールチェック
  │  └─ canAccessFeature('my-library', entitlement) ← ⚠️ 模擬値
  ├─ アクセス不可 → 空配列を設定
  └─ アクセス可能 → データベースから取得
  ↓
[フィルタリング]
  └─ filteredSongs = songs.filter(song => song.status === filterStatus)
```

### 楽曲保存フロー
```
[saveSong()]
  ├─ バリデーション（曲名必須）
  ├─ 認証チェック
  ├─ 編集モード
  │  └─ supabase.from('my_songs').update()
  └─ 新規追加モード
     └─ supabase.from('my_songs').insert()
  └─ 成功メッセージ表示
```

## 10. 結論

マイライブラリフローは機能しているが、以下の改善が必要：
- エントイトルメントの実際の値取得（最重要）
- エラーハンドリングの追加

これらの改善により、ペイウォールが正しく機能し、エラーが適切に処理されるようになる。




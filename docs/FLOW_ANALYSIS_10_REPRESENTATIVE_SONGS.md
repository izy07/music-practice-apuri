# 機能フロー分析レポート #10: 代表曲フロー

## 概要
代表曲一覧の表示、データベースからの取得、フォールバックデータの使用、YouTubeリンクの開き方の各フローを詳細に分析し、余分な工程や潜在的なバグを特定する。

## 1. 代表曲データ読み込みフロー

### ユーザー操作の流れ
1. 代表曲画面 (`app/representative-songs.tsx`) を開く
2. 楽器IDに基づいて代表曲を取得
3. データベースから取得できない場合は空配列を表示

### データの流れ

#### フロントエンド処理 (`app/representative-songs.tsx`)
```
画面表示
  ↓
loadSongs()
  ├─ 楽器情報を取得
  │  └─ supabase.from('instruments').select().eq('id', instrumentId)
  ├─ 代表曲を取得
  │  └─ supabase.from('representative_songs')
  │     .select('*')
  │     .eq('instrument_id', instrumentId)
  │     .order('display_order')
  ├─ エラーハンドリング
  │  ├─ テーブル不存在エラー → 空配列
  │  └─ その他のエラー → エラー表示
  └─ データがある場合は表示、ない場合は空配列
```

### 問題点・余分な工程

#### 🟡 問題1: フォールバックデータが使用されていない
**場所**: `app/representative-songs.tsx:116-127`
- `getFallbackSongs()`関数が定義されているが、使用されていない
- データベースにデータがない場合は空配列を表示

**現状**: 
- データベースに代表曲がない場合は空配列を表示
- フォールバックデータは使用しない仕様

**評価**: 
- これは仕様として意図されている可能性がある
- フォールバックデータを使用する場合は、コメントを追加

#### 🟡 問題2: エラーハンドリングの複雑さ
**場所**: `app/representative-songs.tsx:89-105`
- 複数のエラーコードとメッセージをチェックしている
- エラーハンドリングが複雑

**改善提案**: 
- エラーハンドリングを共通化
- または、エラー検出関数を作成

## 2. YouTubeリンク開き方フロー

### ユーザー操作の流れ
1. 代表曲カードをタップ
2. 確認ダイアログが表示される
3. 「開く」を選択
4. YouTubeリンクが開かれる

### データの流れ (`app/representative-songs.tsx:217-249`)
```
[代表曲カードタップ]
  ↓
handleSongPress(song)
  ├─ song.youtube_urlチェック
  ├─ Alert.alert() - 確認ダイアログ
  └─ Linking.openURL(url) - YouTubeリンクを開く
```

### 問題点

特に大きな問題は見当たらない。

## 3. 代表曲データの重複問題

### データソース
- データベース: `representative_songs`テーブル
- フォールバック: `data/instrumentGuides.ts`（現在は使用されていない）

### 問題点

#### ✅ 問題1: 代表曲データの重複（解決済み）
**状態**: ✅ **解決済み**

詳細は `REPRESENTATIVE_SONGS_DUPLICATE_ANALYSIS.md` を参照。

**解決内容**: 
- バイオリン部分を削除したマイグレーションファイル:
  - `20250817000004_create_representative_songs.sql`
  - `20251205000000_create_and_populate_representative_songs.sql`
- バイオリン専用ファイルを削除:
  - `20251203000000_restore_violin_representative_songs.sql`
  - `20250817000007_add_violin_representative_songs.sql`
- 保持ファイル:
  - `20250120000002_create_representative_songs.sql` - バイオリンの代表曲13曲を定義

## 4. 余分なファイル・重複コード

### 未使用の可能性がある関数
- `getFallbackSongs()` - フォールバックデータ取得関数（定義されているが使用されていない）

**評価**: 
- 仕様としてフォールバックデータを使用しない場合、関数を削除
- または、将来的に使用する場合はコメントを追加

## 5. 潜在的なバグ

### バグ1: フォールバックデータの未使用
- `getFallbackSongs()`関数が定義されているが使用されていない
- データベースにデータがない場合、空配列を表示するのみ

### バグ2: エラーハンドリングの複雑さ
- 複数のエラーコードとメッセージをチェックしている
- エラー検出が不確実な可能性

## 6. 改善提案まとめ

### 優先度: 中
1. **フォールバックデータ関数の整理**: 使用しない場合は削除、または将来的に使用する場合はコメントを追加
2. **エラーハンドリングの共通化**: エラー検出関数を作成

### 優先度: 低
3. **フォールバックデータの使用**: データベースにデータがない場合、フォールバックデータを使用する仕様に変更

## 7. フロー図（テキストベース）

### 代表曲データ読み込みフロー
```
[画面表示]
  ↓
[loadSongs()]
  ├─ 楽器情報を取得
  ├─ 代表曲を取得
  │  └─ データベースから取得
  ├─ エラーハンドリング
  │  ├─ テーブル不存在 → 空配列
  │  └─ その他のエラー → エラー表示
  └─ データがある場合は表示、ない場合は空配列
```

### YouTubeリンク開き方フロー
```
[代表曲カードタップ]
  ↓
[handleSongPress()]
  ├─ youtube_urlチェック
  ├─ 確認ダイアログ表示
  └─ Linking.openURL() - YouTubeリンクを開く
```

## 8. 結論

代表曲フローは機能しているが、以下の改善が必要：
- フォールバックデータ関数の整理（使用しない場合は削除）
- エラーハンドリングの共通化

データの重複問題は既に解決済み。これらの改善により、コードの可読性向上が期待できる。


# 代表曲データ重複問題の分析

## 問題概要
同じ楽器（特にバイオリン）に対して複数のマイグレーションファイルに代表曲データが定義されており、重複データが作成される可能性がある。

## 重複しているデータソース

### 1. マイグレーションファイル内の重複

#### バイオリンの代表曲が定義されているファイル

##### ファイル1: `20250120000002_create_representative_songs.sql`
- **バイオリンの代表曲**: 13曲
- **特徴**: 最初に作成されたマイグレーション
- **重複チェック**: `ON CONFLICT DO NOTHING`（全体に対して）
- **楽曲リスト**:
  1. コウモリ序曲
  2. 情熱大陸
  3. G線のアリア
  4. チャルダッシュ
  5. ツィゴイネルワイゼン
  6. カプリース第24番
  7. 四季「春」
  8. 愛の挨拶
  9. ハバネラ
  10. ユーモレスク
  11. メンデルスゾーンのバイオリン協奏曲 第1楽章
  12. ブラームスのバイオリン協奏曲 第1楽章
  13. 二つのバイオリンのための協奏曲

##### ファイル2: `20250817000004_create_representative_songs.sql`
- **バイオリンの代表曲**: ~~5曲~~ **削除済み**
- **状態**: ✅ **バイオリン部分を削除**（2025-01-20のファイルに統合済み）
- **特徴**: ピアノ、フルート、ギター、トランペットを含む複数楽器（バイオリン部分は削除）
- **削除理由**: `20250120000002_create_representative_songs.sql`に統合済みのため

##### ファイル3: `20251205000000_create_and_populate_representative_songs.sql`
- **バイオリンの代表曲**: ~~15曲~~ **削除済み**
- **状態**: ✅ **バイオリン部分を削除**（2025-01-20のファイルに統合済み）
- **特徴**: テーブル作成とインデックス作成のみ（バイオリン部分は削除）
- **削除理由**: `20250120000002_create_representative_songs.sql`に統合済みのため

##### ファイル4: `20251203000000_restore_violin_representative_songs.sql`
- **状態**: ✅ **ファイル全体を削除**（バイオリン専用ファイルのため）
- **削除理由**: `20250120000002_create_representative_songs.sql`に統合済みのため

##### ファイル5: `20250817000007_add_violin_representative_songs.sql`
- **状態**: ✅ **ファイル全体を削除**（バイオリン専用ファイルのため）
- **削除理由**: `20250120000002_create_representative_songs.sql`に統合済みのため

### 2. フォールバックデータ

#### `data/instrumentGuides.ts`
- **バイオリンの代表曲**: `repertoire`セクションに定義
- **用途**: データベースから取得できない場合のフォールバック
- **問題**: データベースデータと重複する可能性

## 重複の影響

### 1. データベースへの影響
- 同じ楽曲が複数回INSERTされる可能性
- `ON CONFLICT DO NOTHING`や`WHERE NOT EXISTS`があっても、完全には防げない可能性
- 主キーが異なるため、重複レコードが作成される可能性

### 2. アプリケーションへの影響
- 代表曲一覧画面で同じ楽曲が複数回表示される可能性
- `display_order`が異なる場合、順序が混乱する可能性
- データの一貫性が保証されない

### 3. マイグレーション実行時の影響
- 複数のマイグレーションが順番に実行されると、重複データが作成される
- 最新のマイグレーション（`20251205000000`）が最後に実行される場合、それ以前のデータとの重複チェックが機能しない可能性

## 解決方針

### 方針1: 最新のマイグレーションを残し、古いものを削除（推奨）

**理由**:
- `20251205000000_create_and_populate_representative_songs.sql`が最新で、重複チェックも含まれている
- 他の楽器（ピアノ、フルート、ギター、トランペット）のデータも含まれている

**削除対象**:
- `20250120000002_create_representative_songs.sql` - バイオリンのみ、古い
- `20250817000004_create_representative_songs.sql` - バイオリン部分が重複（他の楽器データは必要か確認）

**注意点**:
- 既に実行されたマイグレーションは削除できない（履歴として残す必要がある）
- 代わりに、新しいマイグレーションで重複データを削除する

### 方針2: 重複データ削除マイグレーションを作成

**内容**:
1. 同じ楽器・同じタイトル・同じ作曲家のレコードを特定
2. `display_order`が小さいもの、または`created_at`が古いものを残す
3. 残りのレコードを削除

### 方針3: 統合マイグレーションを作成

**内容**:
1. すべての楽器の代表曲を1つのマイグレーションに統合
2. 重複チェックを徹底
3. 既存データをクリーンアップしてから新規データを挿入

## 推奨アクション

### 即座に実施すべきこと

1. **重複データの確認**
   ```sql
   SELECT instrument_id, title, composer, COUNT(*) as count
   FROM representative_songs
   GROUP BY instrument_id, title, composer
   HAVING COUNT(*) > 1;
   ```

2. **重複データの削除マイグレーション作成**
   - 最新のマイグレーション（`20251205000000`）のデータを基準とする
   - 古い重複レコードを削除

3. **将来の重複を防ぐ**
   - 新しいマイグレーションでは必ず`WHERE NOT EXISTS`チェックを使用
   - または、UNIQUE制約を追加（`instrument_id`, `title`, `composer`）

### 長期的な改善

1. **データソースの一元化**
   - 代表曲データを1つのファイルに集約
   - マイグレーションではなく、シードデータとして管理

2. **フォールバックデータの整理**
   - `instrumentGuides.ts`の`repertoire`は最小限に
   - データベースが利用できない場合のみ使用

3. **データ整合性チェック**
   - 定期的に重複データをチェックするスクリプト
   - CI/CDパイプラインに組み込む

## 具体的な削除候補ファイル

### ✅ 削除済みファイル
- ✅ `20250817000004_create_representative_songs.sql` - **バイオリン部分を削除**（他の楽器データは保持）
- ✅ `20251205000000_create_and_populate_representative_songs.sql` - **バイオリン部分を削除**（テーブル作成は保持）
- ✅ `20251203000000_restore_violin_representative_songs.sql` - **ファイル全体を削除**
- ✅ `20250817000007_add_violin_representative_songs.sql` - **ファイル全体を削除**

### 保持ファイル（バイオリンの代表曲の唯一のソース）
- ✅ `20250120000002_create_representative_songs.sql` - **バイオリンの代表曲13曲を定義**（保持）

## 結論

代表曲データは複数のマイグレーションファイルに分散しており、特にバイオリンに関しては明確な重複が存在する。最新のマイグレーション（`20251205000000`）を基準として、古いマイグレーションのバイオリン部分を削除し、重複データ削除マイグレーションを作成することを推奨する。


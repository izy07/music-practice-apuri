# 機能フロー分析レポート #8: 学習ツール（基礎練習）フロー

## 概要
基礎練習メニューの表示、レベル選択、練習完了記録、姿勢カメラ機能の各フローを詳細に分析し、余分な工程や潜在的なバグを特定する。

## 1. 基礎練習メニュー表示フロー

### ユーザー操作の流れ
1. 基礎練習画面 (`app/(tabs)/basic-practice.tsx`) を開く
2. 楽器別の練習メニューが表示される
3. レベル（初級・中級・上級）を選択
4. 選択したレベルのメニューがフィルタリングされて表示される

### データの流れ

#### フロントエンド処理 (`app/(tabs)/basic-practice.tsx`)
```
画面表示
  ↓
usePracticeLevel() - ユーザーレベルを確認
  ├─ AsyncStorageから読み込み
  ├─ データベースから読み込み
  └─ 未設定の場合はモーダル表示
  ↓
usePracticeMenu(selectedInstrument, selectedLevel)
  ├─ 楽器キーを取得
  ├─ 楽器固有のメニューを取得
  ├─ 共通メニューと結合
  └─ 選択されたレベルでフィルタリング
  ↓
練習メニュー一覧を表示
```

### 問題点・余分な工程

#### 🟡 問題1: 練習メニューデータのハードコード
**場所**: `lib/tabs/basic-practice/data/_practiceMenus.ts`, `_instrumentSpecificMenus.ts`
- 練習メニューがコード内にハードコードされている
- 楽器やメニューが追加された場合、コード修正が必要

**改善提案**: 
- データベースに保存
- または、設定ファイルに分離

## 2. レベル選択フロー

### ユーザー操作の流れ
1. レベルセレクターでレベルを選択
2. ユーザーの演奏レベルがデータベースに保存される
3. 選択したレベルのメニューが表示される

### データの流れ (`lib/tabs/basic-practice/hooks/usePracticeLevel.ts`)
```
[レベル選択]
  ↓
handleLevelSelection(level)
  ├─ ローカル状態を更新
  ├─ AsyncStorageに保存
  └─ データベースに保存
     └─ updatePracticeLevel(userId, level)
  ↓
[レベル変更]
  ↓
handleLevelChange(newLevel)
  ├─ ローカル状態を更新
  ├─ AsyncStorageに保存
  └─ データベースに保存
```

### 問題点

#### 🟡 問題1: レベル変更時の確認ダイアログがない
**場所**: `lib/tabs/basic-practice/hooks/usePracticeLevel.ts:141-165`
- レベル変更時に確認ダイアログがない
- 誤操作でレベルが変更される可能性

**改善提案**: 
- レベル変更時に確認ダイアログを表示
- または、レベル変更を一時的なものとして扱う（画面内でのみ有効）

#### 🟡 問題2: AsyncStorageとデータベースの二重保存
**場所**: `lib/tabs/basic-practice/hooks/usePracticeLevel.ts:114, 123`
- AsyncStorageとデータベースの両方に保存
- 同期が取れていない可能性

**改善提案**: 
- データベースを唯一の情報源にする
- AsyncStorageはキャッシュとして使用

## 3. 練習完了記録フロー

### ユーザー操作の流れ
1. 練習メニューを選択
2. 詳細モーダルで「練習した！」ボタンをクリック
3. 練習記録が保存される（時間は追加されない、✅マークのみ）

### データの流れ (`lib/tabs/basic-practice/components/PracticeDetailModal.tsx:36-125`)
```
[練習した！ボタンクリック]
  ↓
handleSavePractice()
  ├─ 今日の既存記録を取得
  ├─ 既存記録がある場合
  │  ├─ contentにメニュー名を追加
  │  └─ input_method = 'preset'に設定
  ├─ 既存記録がない場合
  │  ├─ 新規記録を作成
  │  ├─ duration_minutes = 0
  │  └─ input_method = 'preset'
  ├─ カレンダー更新イベントを発火
  └─ 成功メッセージを表示
```

### 問題点

#### 🟡 問題1: 既存記録の更新処理の複雑さ
**場所**: `lib/tabs/basic-practice/components/PracticeDetailModal.tsx:63-89`
- 既存記録を取得して更新する処理
- `content`のクリーンアップ処理が複雑

**改善提案**: 
- 統合保存ロジックを使用（`savePracticeSessionWithIntegration`）
- または、処理を簡素化

#### 🟡 問題2: 基礎練の記録が時間を追加しない仕様
**場所**: `lib/tabs/basic-practice/components/PracticeDetailModal.tsx:95`
```typescript
duration_minutes: 0, // 基礎練は時間を追加しない
```

**問題**: 
- 基礎練の記録は時間を追加しない
- カレンダーでは✅マークのみ表示
- 統計には含まれない

**評価**: 
- これは仕様として意図されている可能性がある
- 基礎練は時間ではなく、練習内容として記録する

## 4. 姿勢カメラ機能フロー

### ユーザー操作の流れ
1. 基礎情報セクションで「姿勢チェック」ボタンをクリック
2. カメラモーダルが表示される
3. カメラの権限を許可
4. カメラが起動する

### データの流れ (`components/PostureCameraModal.tsx`)
```
[姿勢チェックボタンクリック]
  ↓
PostureCameraModal表示
  ├─ カメラ権限チェック
  │  ├─ 権限なし → 権限要求
  │  └─ 権限あり → カメラ起動
  └─ カメラ機能（Web環境では利用不可）
```

### 問題点

#### 🟡 問題1: Web環境でのカメラ機能の制限
**場所**: `components/PostureCameraModal.tsx:18-31`
- Web環境では`expo-camera`をインポートしない
- カメラ機能が利用できない

**改善提案**: 
- Web環境でもカメラ機能を利用できるようにする
- または、Web環境では機能を非表示にする

## 5. 楽器別メニューのフィルタリング

### データの流れ (`lib/tabs/basic-practice/hooks/usePracticeMenu.ts`)
```
[楽器変更]
  ↓
usePracticeMenu(selectedInstrument, selectedLevel)
  ├─ 楽器キーを取得（getInstrumentKey）
  ├─ 楽器固有のメニューを取得
  ├─ 共通メニューと結合
  └─ 選択されたレベルでフィルタリング
```

### 問題点

特に大きな問題は見当たらない。

## 6. 余分なファイル・重複コード

### 重複している処理

特に大きな重複は見当たらない。

## 7. 潜在的なバグ

### バグ1: レベル変更の確認なし
- レベル変更時に確認ダイアログがない
- 誤操作でレベルが変更される可能性

### バグ2: AsyncStorageとデータベースの不整合
- レベルがAsyncStorageとデータベースの両方に保存されている
- 同期が取れていない可能性

## 8. 改善提案まとめ

### 優先度: 高
1. **レベル変更時の確認ダイアログ**: 誤操作を防ぐ

### 優先度: 中
2. **AsyncStorageとデータベースの統一**: データベースを唯一の情報源にする
3. **既存記録の更新処理の簡素化**: 統合保存ロジックを使用

### 優先度: 低
4. **練習メニューデータの外部化**: データベースまたは設定ファイルに保存
5. **Web環境でのカメラ機能**: 利用可能にする、または非表示にする

## 9. フロー図（テキストベース）

### 基礎練習メニュー表示フロー
```
[画面表示]
  ↓
[ユーザーレベル確認]
  ├─ AsyncStorageから読み込み
  ├─ データベースから読み込み
  └─ 未設定 → モーダル表示
  ↓
[練習メニューフィルタリング]
  ├─ 楽器固有メニュー取得
  ├─ 共通メニューと結合
  └─ レベルでフィルタリング
  ↓
[練習メニュー一覧表示]
```

### 練習完了記録フロー
```
[練習した！ボタンクリック]
  ↓
[今日の既存記録を取得]
  ↓
[既存記録がある]
  ├─ contentにメニュー名を追加
  └─ input_method = 'preset'に設定
  ↓
[既存記録がない]
  ├─ 新規記録を作成
  ├─ duration_minutes = 0
  └─ input_method = 'preset'
  ↓
[カレンダー更新イベントを発火]
  ↓
[成功メッセージ表示]
```

## 10. 結論

基礎練習フローは機能しているが、以下の改善が必要：
- レベル変更時の確認ダイアログ（誤操作防止）
- AsyncStorageとデータベースの統一
- 既存記録の更新処理の簡素化

これらの改善により、ユーザー体験の向上とコードの可読性向上が期待できる。



